name: Deploy Private AI Stack to DigitalOcean

on:
  push:
    branches:
      - main
    paths:
      # Only trigger on infrastructure or core application changes
      - 'terraform/**'
      - 'docker-compose.yml'
      - 'n8n_workflows/**'
      - '.github/workflows/**'
      # Ignore documentation changes
      - '!README.md'
      - '!*.md'
      - '!docs/**'
      - '!client-interface.html'
      - '!cost-analysis.md'
      - '!wiki/**'
  workflow_dispatch:
    inputs:
      command:
        description: 'Action to perform'
        required: true
        default: 'deploy'
        type: choice
        options:
          - deploy
          - restart-services
          - update-workflows
          - cleanup-all
      force_rebuild:
        description: 'Force complete rebuild (destroys server)'
        required: false
        default: false
        type: boolean

jobs:
  check-action:
    runs-on: ubuntu-latest
    outputs:
      action: ${{ steps.determine.outputs.action }}
      skip_cleanup: ${{ steps.determine.outputs.skip_cleanup }}
    steps:
      - name: Determine deployment action
        id: determine
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "action=${{ github.event.inputs.command }}" >> $GITHUB_OUTPUT
            if [[ "${{ github.event.inputs.force_rebuild }}" == "true" || "${{ github.event.inputs.command }}" == "cleanup-all" ]]; then
              echo "skip_cleanup=false" >> $GITHUB_OUTPUT
            else
              echo "skip_cleanup=true" >> $GITHUB_OUTPUT
            fi
          else
            # Check what files were changed
            echo "action=smart-deploy" >> $GITHUB_OUTPUT
            echo "skip_cleanup=true" >> $GITHUB_OUTPUT
          fi

  conditional-cleanup:
    runs-on: ubuntu-latest
    needs: check-action
    if: needs.check-action.outputs.skip_cleanup == 'false'
    steps:
      - name: Auto-Cleanup Old Servers
        run: |
          echo "ðŸ§¹ CLEANUP TRIGGERED: Removing existing servers..."
          
          RESPONSE=$(curl -s -X GET \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.DIGITALOCEAN_TOKEN }}" \
            "https://api.digitalocean.com/v2/droplets?per_page=200")
          
          echo "ðŸ“Š Current Droplets:"
          if echo "$RESPONSE" | jq -e '.droplets | length > 0' > /dev/null; then
            echo "$RESPONSE" | jq -r '.droplets[] | "ðŸ–¥ï¸ \(.name) (ID: \(.id)) - \(.status)"'
            
            OLD_IDS=$(echo "$RESPONSE" | jq -r '.droplets[].id')
            for id in $OLD_IDS; do
              echo "ðŸ—‘ï¸ Deleting droplet ID: $id"
              curl -s -X DELETE \
                -H "Authorization: Bearer ${{ secrets.DIGITALOCEAN_TOKEN }}" \
                "https://api.digitalocean.com/v2/droplets/$id"
            done
            
            echo "â³ Waiting for cleanup..."
            sleep 30
          else
            echo "âœ… No servers to clean up"
          fi

  smart-deploy:
    runs-on: ubuntu-latest
    needs: [check-action, conditional-cleanup]
    if: always() && (needs.conditional-cleanup.result == 'success' || needs.conditional-cleanup.result == 'skipped')
    outputs:
      droplet_ip: ${{ steps.get_or_create.outputs.droplet_ip }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.5.0
          terraform_wrapper: false

      - name: Get or Create Infrastructure
        id: get_or_create
        run: |
          cd terraform
          
          # Check if we need to create new infrastructure
          if [[ "${{ needs.check-action.outputs.action }}" == "cleanup-all" || "${{ needs.check-action.outputs.skip_cleanup }}" == "false" ]]; then
            echo "ðŸ—ï¸ Creating fresh infrastructure..."
            terraform init
            terraform apply -auto-approve -var="do_token=${{ secrets.DIGITALOCEAN_TOKEN }}"
            DROPLET_IP=$(terraform output -json | jq -r '.droplet_ip_address.value')
          else
            echo "ðŸ” Checking for existing server..."
            RESPONSE=$(curl -s -X GET \
              -H "Authorization: Bearer ${{ secrets.DIGITALOCEAN_TOKEN }}" \
              "https://api.digitalocean.com/v2/droplets")
            
            EXISTING_IP=$(echo "$RESPONSE" | jq -r '.droplets[] | select(.name | contains("private-ai")) | .networks.v4[] | select(.type=="public") | .ip_address' | head -n1)
            
            if [[ "$EXISTING_IP" != "null" && "$EXISTING_IP" != "" ]]; then
              echo "âœ… Using existing server: $EXISTING_IP"
              DROPLET_IP="$EXISTING_IP"
            else
              echo "ðŸ—ï¸ No existing server found, creating new one..."
              terraform init
              terraform apply -auto-approve -var="do_token=${{ secrets.DIGITALOCEAN_TOKEN }}"
              DROPLET_IP=$(terraform output -json | jq -r '.droplet_ip_address.value')
            fi
          fi
          
          echo "droplet_ip=$DROPLET_IP" >> $GITHUB_OUTPUT
          echo "ðŸŽ¯ Server IP: $DROPLET_IP"

  deploy:
    runs-on: ubuntu-latest
    needs: [check-action, smart-deploy]
    steps:
      - name: Wait for SSH availability
        run: |
          echo "â³ Ensuring SSH is ready..."
          for i in {1..10}; do
            if ssh-keyscan -H ${{ needs.smart-deploy.outputs.droplet_ip }} > /dev/null 2>&1; then
              echo "âœ… SSH is ready"
              break
            fi
            echo "Waiting... ($i/10)"
            sleep 10
          done

      - name: Deploy or Update Services
        uses: appleboy/ssh-action@master
        with:
          host: ${{ needs.smart-deploy.outputs.droplet_ip }}
          username: root
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
            
            # Install Docker if not present
            if ! command -v docker &> /dev/null; then
              echo "ðŸ³ Installing Docker..."
              curl -fsSL https://get.docker.com -o get-docker.sh
              sh get-docker.sh
              systemctl start docker
              systemctl enable docker
            fi
            
            # Clone or update repository
            if [ -d "/root/private-ai" ]; then
              echo "ðŸ”„ Updating existing deployment..."
              cd /root/private-ai
              git pull origin main
            else
              echo "ðŸ“¦ Fresh deployment..."
              git clone https://github.com/${{ github.repository }}.git /root/private-ai
              cd /root/private-ai
            fi
            
            # Set environment
            echo "N8N_HOST=${{ needs.smart-deploy.outputs.droplet_ip }}" > .env
            
            # Deploy services based on action
            case "${{ needs.check-action.outputs.action }}" in
              "restart-services")
                echo "ðŸ”„ Restarting services..."
                docker compose restart
                ;;
              "update-workflows")
                echo "ðŸ“‹ Updating n8n workflows..."
                # Copy workflows and restart n8n
                docker compose cp n8n_workflows/. n8n_service:/home/node/.n8n/workflows/
                docker compose restart n8n
                ;;
              *)
                echo "ðŸš€ Full deployment..."
                docker compose down --remove-orphans || true
                docker compose up -d
                
                echo "â³ Waiting for services..."
                sleep 60
                
                # Auto-import workflows
                if [ -d "n8n_workflows" ]; then
                  echo "ðŸ“‹ Importing n8n workflows..."
                  docker compose exec -T n8n n8n import:workflow --input=/home/node/.n8n/workflows/ || true
                fi
                
                # Install Llama3 model
                echo "ðŸ¤– Installing Mistral model..."
                docker compose exec -d ollama ollama pull mistral
                
                # Health checks
                echo "ðŸ” Running health checks..."
                for i in {1..5}; do
                  if curl -s http://localhost:11434/api/generate -d '{"model":"mistral","prompt":"test"}' > /dev/null; then
                    echo "âœ… Ollama is healthy"
                    break
                  fi
                  echo "Waiting for Ollama... ($i/5)"
                  sleep 10
                done
                
                for i in {1..5}; do
                  if curl -s http://localhost:8000/api/v1/collections > /dev/null; then
                    echo "âœ… ChromaDB is healthy"
                    break
                  fi
                  echo "Waiting for ChromaDB... ($i/5)"
                  sleep 10
                done
                ;;
            esac
            
            echo "âœ… Deployment completed successfully!"

  summary:
    runs-on: ubuntu-latest
    needs: [check-action, smart-deploy, deploy]
    if: always()
    steps:
      - name: Deployment Summary
        run: |
          echo "## ðŸŽ¯ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "**Action:** ${{ needs.check-action.outputs.action }}" >> $GITHUB_STEP_SUMMARY
          echo "**Server IP:** ${{ needs.smart-deploy.outputs.droplet_ip }}" >> $GITHUB_STEP_SUMMARY
          echo "**Services:**" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“Š n8n: http://${{ needs.smart-deploy.outputs.droplet_ip }}:5678" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ¤– Ollama: http://${{ needs.smart-deploy.outputs.droplet_ip }}:11434" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“Š ChromaDB: http://${{ needs.smart-deploy.outputs.droplet_ip }}:8000" >> $GITHUB_STEP_SUMMARY
          
          # Check service status
          echo "**Service Status:**" >> $GITHUB_STEP_SUMMARY
          if curl -s http://${{ needs.smart-deploy.outputs.droplet_ip }}:11434/api/generate -d '{"model":"mistral","prompt":"test"}' > /dev/null; then
            echo "âœ… Ollama: Running" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Ollama: Not responding" >> $GITHUB_STEP_SUMMARY
          fi
          
          if curl -s http://${{ needs.smart-deploy.outputs.droplet_ip }}:8000/api/v1/collections > /dev/null; then
            echo "âœ… ChromaDB: Running" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ ChromaDB: Not responding" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [[ "${{ needs.check-action.outputs.skip_cleanup }}" == "true" ]]; then
            echo "ðŸ’¡ **Server preserved** - no cleanup performed" >> $GITHUB_STEP_SUMMARY
          else
            echo "ðŸ§¹ **Fresh deployment** - old servers cleaned up" >> $GITHUB_STEP_SUMMARY
          fi
