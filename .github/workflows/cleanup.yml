name: DigitalOcean Droplet Management & Cleanup

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'list'
        type: choice
        options:
        - list
        - cleanup-old
        - cleanup-all-except-current
      days_old:
        description: 'Delete droplets older than X days'
        required: false
        default: '1'

jobs:
  manage-droplets:
    runs-on: ubuntu-latest
    steps:
      - name: List All Droplets
        if: github.event.inputs.action == 'list'
        run: |
          echo "ğŸ” Scanning DigitalOcean account for all Droplets..."
          
          RESPONSE=$(curl -s -X GET \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.DIGITALOCEAN_TOKEN }}" \
            "https://api.digitalocean.com/v2/droplets?per_page=200")
          
          echo "ğŸ“Š DROPLET INVENTORY:"
          echo "===================="
          
          if echo "$RESPONSE" | jq -e '.droplets | length > 0' > /dev/null; then
            echo "$RESPONSE" | jq -r '.droplets[] | 
              "ğŸ–¥ï¸  ID: \(.id)
              ğŸ“› Name: \(.name) 
              ğŸ“Š Status: \(.status)
              ğŸŒ IP: \(.networks.v4[0].ip_address // "No IP")
              ğŸ“… Created: \(.created_at)
              ğŸ’° Size: \(.size_slug) ($\(.size.price_monthly)/month)
              ğŸ·ï¸  Tags: \(.tags | join(", ") // "None")
              â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"'
            
            TOTAL_COST=$(echo "$RESPONSE" | jq '[.droplets[].size.price_monthly] | add')
            echo ""
            echo "ğŸ’° TOTAL MONTHLY COST: \$$TOTAL_COST"
            echo "ğŸ“ˆ TOTAL DROPLETS: $(echo "$RESPONSE" | jq '.droplets | length')"
          else
            echo "âœ… No droplets found on your account."
          fi

      - name: Cleanup Old Droplets
        if: github.event.inputs.action == 'cleanup-old'
        run: |
          echo "ğŸ§¹ Cleaning up droplets older than ${{ github.event.inputs.days_old }} days..."
          
          DAYS_AGO=${{ github.event.inputs.days_old }}
          CUTOFF_DATE=$(date -u -d "$DAYS_AGO days ago" +"%Y-%m-%dT%H:%M:%SZ")
          echo "ğŸ“… Cutoff date: $CUTOFF_DATE"
          
          RESPONSE=$(curl -s -X GET \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.DIGITALOCEAN_TOKEN }}" \
            "https://api.digitalocean.com/v2/droplets?per_page=200")
          
          OLD_DROPLETS=$(echo "$RESPONSE" | jq --arg cutoff "$CUTOFF_DATE" -r '
            .droplets[] | 
            select(.created_at < $cutoff) | 
            "ID: \(.id) | Name: \(.name) | Created: \(.created_at)"')
          
          if [ -z "$OLD_DROPLETS" ]; then
            echo "âœ… No droplets older than $DAYS_AGO days found."
            exit 0
          fi
          
          echo "ğŸ—‘ï¸  Found old droplets to delete:"
          echo "$OLD_DROPLETS"
          
          OLD_IDS=$(echo "$RESPONSE" | jq --arg cutoff "$CUTOFF_DATE" -r '
            .droplets[] | 
            select(.created_at < $cutoff) | 
            .id')
          
          for id in $OLD_IDS; do
            echo "ğŸ—‘ï¸  Deleting droplet $id..."
            DELETE_RESPONSE=$(curl -s -w "%{http_code}" -X DELETE \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer ${{ secrets.DIGITALOCEAN_TOKEN }}" \
              "https://api.digitalocean.com/v2/droplets/$id")
            
            if [[ "$DELETE_RESPONSE" == *"204"* ]]; then
              echo "âœ… Successfully deleted droplet $id"
            else
              echo "âŒ Failed to delete droplet $id: $DELETE_RESPONSE"
            fi
          done

      - name: Cleanup All Except Current
        if: github.event.inputs.action == 'cleanup-all-except-current'
        run: |
          echo "ğŸ§¹ Cleaning up all droplets except the current one..."
          
          RESPONSE=$(curl -s -X GET \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.DIGITALOCEAN_TOKEN }}" \
            "https://api.digitalocean.com/v2/droplets?per_page=200")
          
          # Keep the most recent private-ai-server
          CURRENT_ID=$(echo "$RESPONSE" | jq -r '
            .droplets[] | 
            select(.name | test("private-ai-server")) | 
            sort_by(.created_at) | 
            reverse | 
            .[0].id')
          
          echo "ğŸ”’ Keeping current droplet ID: $CURRENT_ID"
          
          OLD_IDS=$(echo "$RESPONSE" | jq --arg current "$CURRENT_ID" -r '
            .droplets[] | 
            select(.id != ($current | tonumber)) | 
            .id')
          
          if [ -z "$OLD_IDS" ]; then
            echo "âœ… No old droplets to delete."
            exit 0
          fi
          
          echo "ğŸ—‘ï¸  Deleting old droplets..."
          for id in $OLD_IDS; do
            DROPLET_INFO=$(echo "$RESPONSE" | jq -r --arg id "$id" '.droplets[] | select(.id == ($id | tonumber)) | "\(.name) (Created: \(.created_at))"')
            echo "ğŸ—‘ï¸  Deleting: $DROPLET_INFO"
            
            DELETE_RESPONSE=$(curl -s -w "%{http_code}" -X DELETE \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer ${{ secrets.DIGITALOCEAN_TOKEN }}" \
              "https://api.digitalocean.com/v2/droplets/$id")
            
            if [[ "$DELETE_RESPONSE" == *"204"* ]]; then
              echo "âœ… Successfully deleted droplet $id"
            else
              echo "âŒ Failed to delete droplet $id: $DELETE_RESPONSE"
            fi
          done 